# STM32F407 高性能总线舵机控制系统文档

本文档详细描述了基于 STM32F407VET6 的高性能 USB 转总线舵机控制系统的架构、通信协议及核心代码实现。系统采用 FreeRTOS 实时操作系统，通过 USB CDC 虚拟串口接收上位机（Jetson Nano/PC）的指令，并以 1Mbps 波特率同步驱动 6 个 ST3215 总线舵机。

## 1. 系统架构

*   **MCU**: STM32F407VET6 (主频 168MHz)
*   **操作系统**: FreeRTOS
*   **通信链路**:
    *   **上位机 -> 下位机**: USB CDC (虚拟串口), 采用二进制协议，传输延迟 < 1ms。
    *   **下位机 -> 舵机**: UART (1Mbps) + DMA + 微雪 Bus Servo Adapter (A)。
*   **控制逻辑**:
    1.  **USB 中断**: 接收 21 字节数据包 -> 校验包头 -> 释放信号量 (Semaphore)。
    2.  **舵机任务 (Realtime 优先级)**: 获取信号量 -> 唤醒 -> 解析数据 -> 调用 `ST_SyncWritePos` 发送总线指令。

## 2. 上下位机通信协议规范 (Protocol Specification)

本系统采用紧凑的**定长二进制协议**，以确保在 USB 全速传输下的最高解析效率。

### 2.1 物理层
*   **接口**: USB Type-C / Micro-USB (连接 STM32 USB 从机接口)
*   **设备类型**: USB CDC (虚拟串口)
*   **波特率**: USB 传输不依赖波特率设置，上位机可任意设置（推荐 115200 或 921600 以符合习惯）。

### 2.2 数据链路层 (数据包格式)
*   **包长度**: 固定 **21 字节**
*   **字节序**: 小端模式 (Little-Endian)，即低字节在前。

| 字节索引 | 字段名称 | 长度 | 说明 / 取值 |
| :--- | :--- | :--- | :--- |
| 0 | **帧头 1** | 1 | 固定值 `0xA5` |
| 1 | **帧头 2** | 1 | 固定值 `0x5A` |
| 2 | 舵机 1 ID | 1 | 对应舵机 ID (通常为 1) |
| 3 | 舵机 1 位置_L | 1 | 目标位置低 8 位 |
| 4 | 舵机 1 位置_H | 1 | 目标位置高 8 位 |
| 5 | 舵机 2 ID | 1 | 对应舵机 ID (通常为 2) |
| 6 | 舵机 2 位置_L | 1 | |
| 7 | 舵机 2 位置_H | 1 | |
| ... | ... | ... | (依次类推，共 6 个舵机) |
| 17 | 舵机 6 ID | 1 | 对应舵机 ID (通常为 6) |
| 18 | 舵机 6 位置_L | 1 | |
| 19 | 舵机 6 位置_H | 1 | |
| 20 | **校验和** | 1 | 前 20 个字节累加和的低 8 位 |

### 2.3 数据示例
假设我们要控制 ID=1 的舵机转动到位置 2048 (0x0800)，其他舵机保持 ID 但位置设为 0（简化示例）。

*   **ID 1**: `01`
*   **Pos 2048**: Hex `0800` -> 小端发送 `00 08`
*   **数据包 (Hex)**:
    ```text
    A5 5A 01 00 08 02 00 00 ... [其余数据] ... [Checksum]
    ```

### 2.4 校验算法 (Python 示例)
```python
packet = [0xA5, 0x5A, 0x01, 0x00, 0x08, ...] # 前20个字节
checksum = sum(packet) & 0xFF
packet.append(checksum)
```

## 3. 核心文件说明

### 3.1 `Core/Inc/usb_cmd_handler.h`
定义了协议常量、接收缓冲区和信号量句柄。

### 3.2 `Core/Src/usb_cmd_handler.c`
实现了极速接收回调函数。
*   `USB_Data_Rx_Handler`: 在 USB 中断中调用。它执行简单的包头和长度检查，然后通过 `memcpy` 复制数据并释放信号量。
*   `Servo_Process_Loop`: 在任务中调用。解析缓冲区数据并调用底层驱动。

### 3.3 `Core/Src/st_servo.c` (精简驱动)
实现了基于 HAL 库的 ST 系列舵机驱动。
*   `ST_WritePos`: 单个写位置。
*   `ST_SyncWritePos`: 同步写（Sync Write），将多个舵机的指令打包成一个 UART 数据包发送，实现所有舵机完全同步动作。

### 3.4 `Core/Src/freertos.c` (任务实现)
*   **ServoTask**: 设置为 `osPriorityRealtime` (最高优先级)。
*   逻辑：
    1. 初始化 USB。
    2. 创建二进制信号量。
    3. 给舵机发送上锁指令。
    4. `osSemaphoreAcquire` 阻塞等待 USB 数据。
    5. 收到数据后立即处理。

## 4. 硬件连接指南

1.  **USB 连接**:
    *   STM32 USB Slave 接口 <--> 上位机 (Jetson Nano / PC)
2.  **舵机连接**:
    *   STM32 USART2_TX (PA2) <--> 驱动板 TX (DIN)
    *   STM32 USART2_RX (PA3) <--> 驱动板 RX (DOUT)
    *   驱动板 <--> ST3215 舵机 (注意供电电压 6-12.6V)

## 5. 开发环境

*   **IDE**: Keil MDK-ARM
*   **配置工具**: STM32CubeMX
*   **上位机语言**: Python (推荐) 或 C++